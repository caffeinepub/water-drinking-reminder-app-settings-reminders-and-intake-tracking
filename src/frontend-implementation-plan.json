{
  "kind": "implementation_plan",
  "version": "1.0",
  "title": "Offline saved content mode (action queue + cached read-only data)",
  "requirements": [
    {
      "id": "REQ-34",
      "summary": "Queue and persist user tracking mutations while offline, then auto-replay in order when back online with non-blocking error messaging and cache refresh.",
      "acceptanceCriteria": [
        "When the browser is offline, submitting any of the following actions does not error and instead saves locally: addDailyIntake, addSleepLog, logRun, updateUserSettings.",
        "Queued offline actions are persisted across page reloads (e.g., via localStorage) until successfully synced.",
        "When the browser returns online, queued actions are replayed automatically in the original order and removed from the queue only after backend success.",
        "If a queued action fails to sync (backend error), the UI surfaces a non-blocking English message explaining sync failed and keeps the item queued for a later retry.",
        "After sync completes, relevant React Query caches are refreshed so Today/History/Rewards reflect server state."
      ],
      "file_operations": [
        {
          "path": "frontend/src/offline/offlineQueue.ts",
          "operation": "create",
          "description": "Create a device-local offline action queue with serialization, per-principal namespacing, persistence (localStorage), FIFO ordering, and helpers to enqueue/dequeue/peek without losing items on failure."
        },
        {
          "path": "frontend/src/offline/offlineStorage.ts",
          "operation": "create",
          "description": "Create shared localStorage utilities for safe JSON read/write, per-principal key construction, and data versioning for offline queue/caches."
        },
        {
          "path": "frontend/src/offline/OfflineSyncProvider.tsx",
          "operation": "create",
          "description": "Add a provider component that watches online status, drains the queued actions sequentially using the existing actor, shows non-blocking English toasts on sync failure, stops at the first failing item to preserve order, and invalidates relevant React Query caches after successful replays."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Wrap mutations (addDailyIntake, addSleepLog, logRun, updateUserSettings) to: (1) detect offline and \"Save for offline use\" preference, (2) enqueue actions locally instead of calling the backend when offline, (3) return a result indicating the action was queued so the UI can message appropriately, and (4) keep existing online behavior and post-success invalidations intact."
        },
        {
          "path": "frontend/src/components/intake/QuickAddIntake.tsx",
          "operation": "modify",
          "description": "Update intake logging UX to treat offline-queued submissions as successful (English toast like 'Saved offline. Will sync when back online.') and avoid surfacing an error when the action is queued."
        },
        {
          "path": "frontend/src/components/sleep/SleepLogForm.tsx",
          "operation": "modify",
          "description": "Update sleep logging UX to treat offline-queued submissions as successful with an English non-blocking message and avoid showing a failure when queued."
        },
        {
          "path": "frontend/src/components/running/RunLogForm.tsx",
          "operation": "modify",
          "description": "Update run logging UX to treat offline-queued submissions as successful with an English non-blocking message and avoid showing a failure when queued."
        },
        {
          "path": "frontend/src/components/settings/SettingsForm.tsx",
          "operation": "modify",
          "description": "Update settings save UX to treat offline-queued updates as successful with an English message and avoid showing a failure when queued."
        },
        {
          "path": "frontend/src/App.tsx",
          "operation": "modify",
          "description": "Wire OfflineSyncProvider into the authenticated app subtree so queued actions automatically sync when connectivity is restored."
        }
      ]
    },
    {
      "id": "REQ-35",
      "summary": "Cache last successful user totals and recent history locally and render read-only cached content while offline with a clear stale-data indicator.",
      "acceptanceCriteria": [
        "When online, successful fetches for today’s values and history lists store a copy locally (per signed-in principal).",
        "When offline, the app displays the last cached values for today’s progress and history views (hydration/sleep/running) instead of showing only loading/errors.",
        "The UI clearly indicates the data may be stale while offline using English copy (e.g., “Showing saved data from your last connection.”).",
        "Offline read-only rendering does not require any backend calls and does not crash if no cached data exists (falls back to existing empty/loading states)."
      ],
      "file_operations": [
        {
          "path": "frontend/src/components/offline/OfflineStaleNotice.tsx",
          "operation": "create",
          "description": "Create a small reusable UI component that shows an English stale-data message while offline (e.g., 'Showing saved data from your last connection.') and optionally includes a last-saved timestamp when available."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Enhance relevant React Query hooks (today totals + history lists for hydration/sleep/running) to (1) write successful online results into localStorage per principal when offline saving is enabled, (2) when offline, return cached data without calling the backend, and (3) expose lightweight metadata (e.g., isOfflineData/cachedAt) for the UI to show the stale-data notice."
        },
        {
          "path": "frontend/src/components/intake/TodayProgress.tsx",
          "operation": "modify",
          "description": "When offline and cached data is being used, render OfflineStaleNotice above or within the card; ensure the view does not crash if no cached data exists and current empty/loading behavior remains."
        },
        {
          "path": "frontend/src/components/history/HistoryView.tsx",
          "operation": "modify",
          "description": "When offline and cached hydration history is being used, render OfflineStaleNotice; ensure that if no cached data exists, the existing EmptyState/loading behavior continues without crashes."
        },
        {
          "path": "frontend/src/components/sleep/SleepHistoryList.tsx",
          "operation": "modify",
          "description": "When offline and cached sleep history is being used, render OfflineStaleNotice; keep current empty-state behavior when no cache exists."
        },
        {
          "path": "frontend/src/components/running/RunHistoryList.tsx",
          "operation": "modify",
          "description": "When offline and cached running history is being used, render OfflineStaleNotice; keep current empty-state behavior when no cache exists."
        }
      ]
    },
    {
      "id": "REQ-36",
      "summary": "Add a device-local toggle in existing settings to enable/disable offline saving behavior with English helper text and persisted preference.",
      "acceptanceCriteria": [
        "A toggle labeled in English (e.g., “Save for offline use”) is available in an existing settings surface.",
        "When disabled, the app does not queue new offline actions and does not write new offline caches (existing queued items/caches may be left intact unless the user explicitly clears them).",
        "When enabled, behavior matches REQ-34 and REQ-35.",
        "User preference is persisted locally on the device and restored on reload."
      ],
      "file_operations": [
        {
          "path": "frontend/src/offline/useOfflinePreference.ts",
          "operation": "create",
          "description": "Create a hook to read/write a device-local 'Save for offline use' preference in localStorage and expose it to the app (including default value and reload restoration)."
        },
        {
          "path": "frontend/src/components/settings/SettingsForm.tsx",
          "operation": "modify",
          "description": "Add a 'Save for offline use' toggle using existing UI building blocks (do not modify shadcn components). Include English helper text explaining what is saved (queued logs + cached read-only data) and that sync happens automatically when back online; persist and reflect the current preference."
        },
        {
          "path": "frontend/src/hooks/useQueries.ts",
          "operation": "modify",
          "description": "Respect the offline preference: when disabled, do not enqueue offline actions and do not write new offline caches; keep existing online behavior unchanged."
        },
        {
          "path": "frontend/src/offline/OfflineSyncProvider.tsx",
          "operation": "modify",
          "description": "Respect the offline preference during syncing: when disabled, do not automatically drain/attempt queued sync (existing queued items remain intact for later if the user re-enables)."
        }
      ]
    }
  ]
}